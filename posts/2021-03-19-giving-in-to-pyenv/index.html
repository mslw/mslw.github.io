<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="ie=edge">
<meta name=theme-color content="#494f5c">
<meta name=msapplication-TileColor content="#494f5c">
<meta itemprop=name content="Giving in to pyenv">
<meta itemprop=description content="There are several ways of installing and managing python on macOS, and in this post I am taking a closer look at pyenv. The write-up is divided into two segments. In the first (which I called &ldquo;life story&rdquo; during writing) I explain why I was avoiding pyenv for a long time and what caused me to give in. The second is technical and provides a short reference for creating and using my current setup."><meta itemprop=datePublished content="2021-03-19T00:00:00+00:00">
<meta itemprop=dateModified content="2021-03-19T00:00:00+00:00">
<meta itemprop=wordCount content="1261">
<meta itemprop=keywords content="software,python,tips & tricks,"><meta property="og:title" content="Giving in to pyenv">
<meta property="og:description" content="There are several ways of installing and managing python on macOS, and in this post I am taking a closer look at pyenv. The write-up is divided into two segments. In the first (which I called &ldquo;life story&rdquo; during writing) I explain why I was avoiding pyenv for a long time and what caused me to give in. The second is technical and provides a short reference for creating and using my current setup.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://mslw.github.io/posts/2021-03-19-giving-in-to-pyenv/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-03-19T00:00:00+00:00">
<meta property="article:modified_time" content="2021-03-19T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Giving in to pyenv">
<meta name=twitter:description content="There are several ways of installing and managing python on macOS, and in this post I am taking a closer look at pyenv. The write-up is divided into two segments. In the first (which I called &ldquo;life story&rdquo; during writing) I explain why I was avoiding pyenv for a long time and what caused me to give in. The second is technical and provides a short reference for creating and using my current setup.">
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png>
<link rel=manifest href=/site.webmanifest>
<link rel=mask-icon href=/safari-pinned-tab.svg color>
<link rel="shortcut icon" href=/favicon.ico>
<title>Giving in to pyenv</title><link rel=stylesheet href=https://mslw.github.io/css/style.min.037b6ee8f8c1baab6a3d0a9da11c3ff18a7552471f16c59fd98538d5ce99208b.css integrity="sha256-A3tu6PjBuqtqPQqdoRw/8Yp1UkcfFsWf2YU41c6ZIIs=" crossorigin=anonymous>
<link rel=stylesheet href=https://mslw.github.io/fontawesome/css/all.css>
<link rel=stylesheet href=https://mslw.github.io/academicons/css/academicons.css>
</head><body id=page>
<header id=site-header class="animated slideInUp">
<div class="hdr-wrapper section-inner">
<div class=hdr-left>
<div class=site-branding>
<a href=https://mslw.github.io/>Michał Szczepanik</a>
</div><nav class="site-nav hide-in-mobile">
<a href=https://mslw.github.io/posts/>Posts</a>
<a href=https://mslw.github.io/about>About</a>
</nav></div><div class="hdr-right hdr-icons">
<span class="hdr-social hide-in-mobile"><a href=https://github.com/mslw target=_blank rel="noopener me" title=Github><i class="fab fa-github"></i></a><a href=https://orcid.org/0000-0002-4028-2087 target=_blank rel="noopener me" title=Orcid><i class="fab fa-orcid"></i></a><a href=https://masto.ai/@doktorpanik target=_blank rel="noopener me" title=Mastodon><i class="fab fa-mastodon"></i></a></span><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
</div></div></header><div id=mobile-menu class="animated fast">
<ul>
<li><a href=https://mslw.github.io/posts/>Posts</a></li><li><a href=https://mslw.github.io/about>About</a></li></ul></div><main class="site-main section-inner animated fadeIn faster">
<article class=thin>
<header class=post-header>
<div class=post-meta><span>Mar 19, 2021</span></div><h1>Giving in to pyenv</h1></header><div class=content>
<p>There are several ways of installing and managing python on macOS, and in this post I am taking a closer look at pyenv. The write-up is divided into two segments. In the first (which I called &ldquo;life story&rdquo; during writing) I explain why I was avoiding pyenv for a long time and what caused me to give in. The second is technical and provides a short reference for creating and using my current setup.</p><p>There are, obviously, many blog posts about using pyenv, including ones from <a href=https://realpython.com/intro-to-pyenv/>Real Python</a>, <a href=https://towardsdatascience.com/managing-virtual-environment-with-pyenv-ae6f3fb835f8>Towards Data Science</a> or the one I liked a lot from <a href=https://raycent.medium.com/managing-python-on-macos-the-clean-way-7673cab874f6>Raycent</a>. However, most of what I found didn&rsquo;t cover my use case entirely, so here is a compilation of useful tips (which I wish I had known earlier).</p><h2 id=introduction>Introduction<a href=#introduction class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><h3 id=what-i-used-before>What I used before<a href=#what-i-used-before class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>For a very long time I have been using <a href=https://brew.sh/>homebrew</a> (&ldquo;the missing package manager for macOS&rdquo;) to take care of my python installation. I also use homebrew to install other programs, so doing <code>brew install python3</code> and, if needed <code>brew update python3</code> were nice, easy and natural.</p><p>Another key element was <a href=https://virtualenv.pypa.io/en/stable/>virtualenv</a> (&ldquo;a tool to create isolated python environments&rdquo;). Install python with homebrew, create per-project virtual environments with virtualenv, have a relatively useful set of packages in the global installation and be happy. No need for extensions, not even the popular <a href=https://pypi.org/project/virtualenvwrapper/>virtualenvwrapper</a>. This has served me for quite a while.</p><h3 id=the-turning-point>The turning point<a href=#the-turning-point class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>While homebrew-installed python is easy to update, it is perhaps a little bit too easy: sometimes, I would trigger an update when installing or updating some other program. What&rsquo;s more, the default behaviour of homebrew is to perform cleanup, that is to remove old versions of a program, after installing a new one. This is all well and good in most cases (avoids eating up disk space), but not necessarily with python.</p><p>The problem is that virtualenv does not create a full copy of a python installation; instead, it relies on the existing one (at least by default, and I am not aware of an alternative behaviour). As a result, upgrading python through homebrew will break links to the python used by a given virtual environment. And aside from the issue of breaking existing environments, if an older version of python happens to be needed to build one, then it somehow needs to be installed in the first place.</p><p>So from time to time I had a bad day, because an update broke my python. In most cases, however, I could rebuild any environment (albeit with the new version of python) simply by calling <code>virtualenv path/to/the/env</code> and running <code>pip install -r requirements.txt</code> inside. After all, there isn&rsquo;t that much difference between, say, 3.7 and 3.8 (and it&rsquo;s always nice to have shiny new things, like the <a href=https://www.python.org/dev/peps/pep-0572/#abstract>walrus operator</a>).</p><p>However, some changes are game breaking. As of the day I started drafting this blog post, one of my favourite tools, <a href=https://github.com/miykael/atlasreader>atlasreader</a> (which generates coordinate tables and plots for brain images), would not work on python versions above 3.7. I think it must have been and issue in some of its dependencies, but I didn&rsquo;t investigate further (as a sidenote, I set this draft aside for a long while, and in the meantime things got back to normal: as of day of publishing, atlasreader works fine on python 3.9).</p><p>And this was a story of how I ended up with python 3.9 while needing 3.7.</p><h3 id=assumptions>Assumptions<a href=#assumptions class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>The recommendations below will be most useful for people who, like me:</p><ol>
<li>work on several (potentially drawn-out) projects simultaneously</li><li>rely on some standalone python programs, which may not always be quickly brought up to date</li><li>want to use jupyter lab</li></ol><p>and for these reasons need to have both several versions of python installed and several independent sets of python packages (virtual environments) created for a given python version.</p><p>To this end, pyenv provides a unified, high-level interface for simple installation and swapping out both python versions and specific virtual environments - and has become my tool of choice.</p><h2 id=the-technicalities>The technicalities<a href=#the-technicalities class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>Instructions below are based on MacOS with zsh and homebrew. The specifics will be different, but pyenv will work on other shells and OSs.</p><h3 id=installation---pyenv>Installation - pyenv<a href=#installation---pyenv class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>When using homebrew (though other ways also available), the installation is straightforward. Pre- and post-installation steps are listed in <a href=https://github.com/pyenv/pyenv#homebrew-on-macos>pyenv&rsquo;s readme</a> on github, and can be summarised in three steps:</p><ol>
<li>Instal dependencies if not present already (xcode tools, openssl and the like).</li><li>Install pyenv itself: <code>brew install pyenv</code></li><li>Add pyenv init to the shell by editing the <code>.zshrc</code> (or equivalent) file. More on that later.</li></ol><p>Note: if python was previously installed with homebrew, it does not need to be removed: the pyenv-installed python lives entirely separately from the homebrew-installed one. I did remove it on my desktop (which involved disassembling a tangle of dependencies one by one), but in hindsight it was a waste of time.</p><p>After pyenv, it is good to install <a href=https://github.com/pyenv/pyenv-virtualenv>pyenv-virtualenv</a>, a pyenv plugin which provides features to manage virtual environments, with <code>brew install pyenv-virtualenv</code>. Its readme suggests making another addition to <code>.zshrc</code> (pyenv virtualenv-init, to enable auto-activation of environments), which I personally skipped.</p><p>Unfortunately, pyenv does not mix smoothly with homebrew. When things are left alone, <code>brew doctor</code> will complain about existence of python config files created by pyenv, and, if I understand correctly, homebrew formulae having python as dependency would use the pyenv-managed python (potentially leading to mixups). According to recommendations <a href=https://raycent.medium.com/managing-python-on-macos-the-clean-way-7673cab874f6>here</a> and <a href=https://github.com/pyenv/pyenv/issues/106>here</a>, the best way to deal with it is by adding an alias for homebrew to <code>.zshrc</code>. This should make homebrew oblivious to the existence of pyenv-installed python (the homebrew-installed python will be used as a dependency for everything else homebrew does). While this means having two separate python ecosystems, seamless operation far outweighs the redundancy.</p><p>In the end, here are the three <code>.zshrc</code> additions: one for pyenv, one for pyenv-virtualenv, and one for aliasing homebrew. I placed them all inside the <code>if</code> block (check if pyenv is available) suggested in pyenv&rsquo;s readme.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-zsh data-lang=zsh><span class=line><span class=cl><span class=k>if</span> <span class=nb>command</span> -v pyenv 1&gt;/dev/null 2&gt;<span class=p>&amp;</span>1<span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>	<span class=nb>eval</span> <span class=s2>&#34;</span><span class=k>$(</span>pyenv init -<span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nb>eval</span> <span class=s2>&#34;</span><span class=k>$(</span>pyenv virtualenv-init -<span class=k>)</span><span class=s2>&#34;</span>  <span class=c1># OPTIONAL</span>
</span></span><span class=line><span class=cl>	<span class=nb>alias</span> <span class=nv>brew</span><span class=o>=</span><span class=s1>&#39;env PATH=&#34;${PATH//$(pyenv root)\/shims:/}&#34; brew&#39;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span></code></pre></div><h3 id=organising-things-with-pyenv>Organising things with pyenv<a href=#organising-things-with-pyenv class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>With pyenv installed, I think this is a reasonable way to proceed:</p><ul>
<li>install the latest python version and set it as global</li><li>install other versions, needed for virtualenvs or standalone programs</li><li>install jupyter lab under global</li><li>for each project that uses jupyter, install an ipykernel (see below)</li><li>for each standalone, switch to the needed python version before installation or usage</li></ul><h3 id=organising-things-for-jupyter>Organising things for jupyter<a href=#organising-things-for-jupyter class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>Pyenv or not, I think the right way for working with virtual environments is to install jupyter lab only once, globally (that is under your primary python version), and then only install <em>kernels</em> for each environment you want to use with jupyter (<a href=https://ipython.readthedocs.io/en/stable/install/kernel_install.html>docs here</a>). To install a project-specific (virtualenv-specific) kernel:</p><ul>
<li>Activate virtualenv</li><li>Install the ipykernel package inside: <code>pip install ipykernel</code></li><li>Register a new kernel: <code>ipykernel install --user --name myenv --display-name "Python (myenv)"</code></li><li>Deactivate</li></ul><p>Kernels can be listed with <code>jupyter kernelspec list</code> and, if no longer needed, removed with <code>jupyter kernelspec remove</code>.</p><h3 id=usage-pyenv-commands>Usage: pyenv commands<a href=#usage-pyenv-commands class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>The list of pyenv commands is available <a href=https://github.com/pyenv/pyenv/blob/master/COMMANDS.md>here</a> and can be displayed with <code>pyenv commands</code>. For me, these are the most important:</p><ul>
<li><code>pyenv shell x.y.z</code> to use python x.y.z in the current shell</li><li><code>pyenv activate &lt;name></code> to manually activate a pyenv virtualenv</li><li><code>pyenv whence &lt;some executable></code> to see which environment has that executable (e.g. atlasreader)</li><li><code>pyenv version</code> to see which version is currently active</li><li><code>pyenv versions</code> to see versions available</li><li><code>pyenv help &lt;command></code> to get help for a command</li></ul></div><hr class=post-end>
<footer class=post-info>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-feather"><path d="M20.24 12.24a6 6 0 00-8.49-8.49L5 10.5V19h8.5z"/><line x1="16" y1="8" x2="2" y2="22"/><line x1="17.5" y1="15" x2="9" y2="15"/></svg>Michał Szczepanik</p><p>
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://mslw.github.io/tags/software>software</a></span><span class=tag><a href=https://mslw.github.io/tags/python>python</a></span><span class=tag><a href=https://mslw.github.io/tags/tips-tricks>tips & tricks</a></span>
</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>1261 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2021-03-19 00:00 +0000</p></footer></article><div class="post-nav thin">
<a class=next-post href=https://mslw.github.io/posts/2021-05-05-matlab-table-string/>
<span class=post-nav-label><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>&nbsp;Newer</span><br><span>Matlab table & string</span>
</a>
<a class=prev-post href=https://mslw.github.io/posts/2020-12-17-working-with-siemens-physio/>
<span class=post-nav-label>Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>Working with Siemens physio (.puls) files</span>
</a>
</div><div id=comments class=thin>
</div></main><footer id=site-footer class="section-inner thin animated fadeIn faster">
<p>&copy; 2024 <a href=https://mslw.github.io/>Michał Szczepanik</a> &#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></p><p>
Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://mslw.github.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a>
</p></footer><script src=https://mslw.github.io/js/bundle.min.8256b8724b9578bbdf6d6f04c894255bc760e78e8a2d60ec0a91ea993acd3b77.js integrity="sha256-gla4ckuVeLvfbW8EyJQlW8dg546KLWDsCpHqmTrNO3c=" crossorigin=anonymous></script>
</body></html>